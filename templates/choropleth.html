<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v6.js"></script>
<form method="POST">
<div>
  <h3>Weapon of Crime</h3>
    <label>
      <input type="radio" value="0" name = "weapon" id = "all1" checked />all</label>
    <label>
      <input type="radio" value="ARMA BLANCA / CORTOPUNZANTE" name = "weapon" id = "stabbing weapon" />stabbing weapon</label>
    <label>
      <input type="radio" value="ARMA DE FUEGO" name = "weapon" id="firearm" />firearm</label>      
    <label>
      <input type="radio" value="CONTUNDENTES" name = "weapon" id="blunt" />blunt weapon</label>
    <label>
      <input type="radio" value="CORTANTES" name = "weapon" id="slashing_weapon" />slashing weapon</label>
    <label>
      <input type="radio" value="PUNZANTES" name = "weapon" id="sharp_weapon" />sharp weapon</label>
    <label>
      <input type="radio" value="SIN EMPLEO DE ARMAS" name = "weapon" id="no_weapon" />no weapon</label>
    <label>
      <input type="radio" value="ESCOPOLAMINA" name = "weapon" id="narcotics" />narcotics</label>
</div>
<div>
  <h3>Age group</h3>
  <label>
    <input type="radio" value="0" name = "age" id="all2" checked />all</label>
  <label>
    <input type="radio" value="ADULTOS" name = "age"  id="adult" />adult</label>
  <label>
    <input type="radio" value="ADOLESCENTES" name = "age"  id="teenager" />teenager</label>
  <label>
    <input type="radio" value="MENORES" name = "age"  id="minor" />minor</label>
</div>
<div>
  <h3>Gender of Victim</h3>
  <label>
    <input type="radio" value="0" name = "gender" id="all3" checked />all</label>
  <label>
    <input type="radio" value="MASCULINO" name = "gender" id="male" />male</label>
  <label>
    <input type="radio" value="FEMENINO" name = "gender" id="female" />female</label>
</div>

<div>
    <h3>color sheme</h3>
    <label>
      <input type="radio" value="1" name = "col" id="col1" checked />static</label>
    <label>
      <input type="radio" value="2" name = "col" id="col2" />dynamic</label>
</div>  

<input type="submit" name = "action" value="Submit" onclick="onChange()" />
<section data-type='{{ data|tojson }}'></section>
</form>


<div id="my_dataviz"></div>

<script>


    width = 600,
    height = 600 ;


    const svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")

    var borderPath = svg.append("rect")
       	.attr("x", 0)
       	.attr("y", 0)
       	.attr("height", height)
       	.attr("width", width)
       	.style("stroke", "red")
       	.style("fill", "none")
       	.style("stroke-width", 1);
    
    const path = d3.geoPath();
    const projection = d3.geoMercator()
      .scale(1800)
      .center([-72,4])
      .translate([width / 2, height / 2]);
    
    let data = new Map()
    const colorScale = d3.scaleThreshold()
      .domain([2, 4, 6, 8, 10, 12, 14, 16, 18, 20])
      .range(["#fff7ec","#fee9cb","#fdd8a9","#fdc28c","#fca16d","#f67b52","#e65339","#ce2619","#ab0604","#7f0000"])


    var count = 1;
    let section = document.querySelectorAll("section");
    for (item of section) {
      if(count == 1){
        var dat = JSON.parse(item.getAttribute("data-type"));
      }
      else if(count ==2 ){
        var colo = item.getAttribute("data-type");
      }
      count += 1

    }
    let a = []
    for (x in dat){
        a.push(dat[x])
    }

    const colorScale2 = d3.scaleQuantize()
        .domain([Math.min(...a), Math.max(...a) ])
        .range(["#fff7ec","#fee9cb","#fdd8a9","#fdc28c","#fca16d","#f67b52","#e65339","#ce2619","#ab0604","#7f0000"])
        //.range(["#fff7ec","#fff7eb","#fff6ea","#fff6e9","#fff5e7","#fff5e6","#fff4e5","#fff4e4","#fff3e3","#fff3e2","#fff2e1","#fff2e0","#fff1de","#fff1dd","#fff0dc","#fff0db","#feefda","#feefd9","#feeed7","#feeed6","#feedd5","#feedd4","#feecd3","#feecd2","#feebd0","#feebcf","#feeace","#feeacd","#fee9cc","#fee9ca","#fee8c9","#fee8c8","#fee7c7","#fee7c6","#fee6c4","#fee5c3","#fee5c2","#fee4c1","#fee4bf","#fee3be","#fee3bd","#fee2bc","#fee1ba","#fee1b9","#fee0b8","#fee0b7","#fedfb5","#fedeb4","#fedeb3","#fdddb2","#fddcb1","#fddcaf","#fddbae","#fddaad","#fddaac","#fdd9ab","#fdd8a9","#fdd8a8","#fdd7a7","#fdd6a6","#fdd6a5","#fdd5a4","#fdd4a3","#fdd4a1","#fdd3a0","#fdd29f","#fdd29e","#fdd19d","#fdd09c","#fdcf9b","#fdcf9a","#fdce99","#fdcd98","#fdcc97","#fdcc96","#fdcb95","#fdca94","#fdc994","#fdc893","#fdc892","#fdc791","#fdc690","#fdc58f","#fdc48e","#fdc38d","#fdc28c","#fdc18b","#fdc08a","#fdbf89","#fdbe88","#fdbd87","#fdbc86","#fdbb85","#fdba84","#fdb983","#fdb882","#fdb781","#fdb680","#fdb57f","#fdb47d","#fdb27c","#fdb17b","#fdb07a","#fdaf79","#fdae78","#fdac76","#fdab75","#fdaa74","#fca873","#fca772","#fca671","#fca46f","#fca36e","#fca26d","#fca06c","#fc9f6b","#fc9e6a","#fc9c68","#fc9b67","#fb9a66","#fb9865","#fb9764","#fb9563","#fb9462","#fb9361","#fb9160","#fa905f","#fa8f5e","#fa8d5d","#fa8c5c","#f98b5b","#f9895a","#f98859","#f98759","#f88558","#f88457","#f88356","#f78155","#f78055","#f77f54","#f67d53","#f67c52","#f67b52","#f57951","#f57850","#f4774f","#f4754f","#f4744e","#f3734d","#f3714c","#f2704c","#f26f4b","#f16d4a","#f16c49","#f06b49","#f06948","#ef6847","#ef6646","#ee6545","#ed6344","#ed6243","#ec6042","#ec5f42","#eb5d41","#ea5c40","#ea5a3f","#e9593e","#e8573c","#e8563b","#e7543a","#e65339","#e65138","#e55037","#e44e36","#e44c35","#e34b34","#e24932","#e14831","#e04630","#e0442f","#df432e","#de412d","#dd402b","#dc3e2a","#dc3c29","#db3b28","#da3927","#d93826","#d83624","#d73423","#d63322","#d53121","#d43020","#d32e1f","#d22c1e","#d12b1d","#d0291b","#cf281a","#ce2619","#cd2518","#cc2317","#cb2216","#ca2015","#c91f14","#c81d13","#c71c12","#c61b11","#c51911","#c31810","#c2170f","#c1150e","#c0140d","#bf130c","#be120c","#bc110b","#bb100a","#ba0e09","#b80d09","#b70c08","#b60b07","#b50b07","#b30a06","#b20906","#b10805","#af0705","#ae0704","#ac0604","#ab0504","#a90503","#a80403","#a60402","#a50302","#a40302","#a20302","#a00201","#9f0201","#9d0201","#9c0101","#9a0101","#990101","#970101","#960100","#940100","#920000","#910000","#8f0000","#8e0000","#8c0000","#8a0000","#890000","#870000","#860000","#840000","#820000","#810000","#7f0000"])
    

    function onChange(){

      svg.selectAll("*").remove();
      var borderPath = svg.append("rect")
       	.attr("x", 0)
       	.attr("y", 0)
       	.attr("height", height)
       	.attr("width", width)
       	.style("stroke", "red")
       	.style("fill", "none")
       	.style("stroke-width", 1);
    }

    function draw_choro(){
    Promise.all([
    d3.json("https://raw.githubusercontent.com/slomu/Colombia_Vis/main/data/col.geojson"),]).then(function(loadData){
        let topo = loadData[0]
        
        const tooltip = d3.select("#my_dataviz")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            //.style("border", "solid")
            //.style("border-width", "2px")
            //.style("border-radius", "2px")
            //.style("padding", "5px")
        
        const mouseOver = function(d) {
            //d3.selectAll(".properties.NOMBRE_DPT")
                //.style("opacity", .5)
            d3.select(this)
                .style("stroke", "black")
                //.style("opacity", 1)
            tooltip.style("opacity", 1)
        }

        const mouseMove = function(event,d) {
            tooltip
                .html("" + d.properties.NOMBRE_DPT + "<br>"+ (Math.round((dat[(d.properties.NOMBRE_DPT)])*100) / 100) + " cases per 1000 inhabitants")
                .style("left", (event.x)/2 + "px")
                .style("top", (event.y)/2 + "px")

        }

        const mouseLeave = function(d) {
            //d3.selectAll(".properties.NOMBRE_DPT")
                //.style("opacity", .8)
            d3.select(this)
                .style("stroke", "transparent")
            tooltip
                .style("opacity", 0)
        }

        color = document.querySelector('input[name="col"]:checked').value;
        console.log(color)
        if(color == "1"){
          color = colorScale
        }
        else if(color == "2"){
          color = colorScale2
        }

        svg.append("g")
            .selectAll("path")
            .data(topo.features)
            .join("path")
            .attr("d", d3.geoPath()
            .projection(projection)
            )
            .attr("fill", (d) => color((dat[(d.properties.NOMBRE_DPT)])))
            .style("stroke", "transparent")
            .attr("class", function(d){ return "properties.NOMBRE_DPT" } )
            .style("opacity", 1)
            .on("mouseover", mouseOver )
            .on("mousemove", mouseMove )
            .on("mouseleave", mouseLeave )
      
    })
  }

  draw_choro()

    </script>